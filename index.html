<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.webp">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.webp">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"peterquan.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="时间需要留下走过的痕迹">
<meta property="og:type" content="website">
<meta property="og:title" content="Quan Qinle">
<meta property="og:url" content="https://peterquan.github.io/index.html">
<meta property="og:site_name" content="Quan Qinle">
<meta property="og:description" content="时间需要留下走过的痕迹">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="权芹乐">
<meta property="article:tag" content="编程">
<meta property="article:tag" content=" 测试">
<meta property="article:tag" content=" 计算机">
<meta property="article:tag" content=" 人生">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://peterquan.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Quan Qinle</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Quan Qinle</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">权芹乐的博客 | QuanQinle's Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2021/03/16/file-templates-in-IDEA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/16/file-templates-in-IDEA/" class="post-title-link" itemprop="url">Java | 使用IDEA的文件模板功能简化Spring Boot的类创建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-17 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-17T00:00:00+08:00">2021-03-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>IntelliJ IDEA Community 2020.3.3</li>
</ul>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>在Spring Boot项目中，每当新增一个entity/module对象时，如<code>UserPO.java</code>，大多时候接下来还要创建对应的repository、service、service implement、controller等，并且最开始类的内容也是相似，一套模板类做下来，慢慢的重复劳动。</p>
<p>于是，想着是否存在根据类模板“一键”创建多个类文件的功能，在<code>Settings</code>中一番翻找，在<code>File and Code Templates</code>中找到了解决办法。本文就是介绍通过文件模板批量创建文件的步骤。</p>
<h1 id="期望-最终效果演示"><a href="#期望-最终效果演示" class="headerlink" title="期望+最终效果演示"></a>期望+最终效果演示</h1><blockquote>
<p>结果即需求</p>
</blockquote>
<p>先演示一下最终实现的效果，也就是最初的需求</p>
<ol>
<li>在包根目录下，右键——&gt;<code>New</code>——&gt;选择新设置的模板，<br><img src="/img/in-post/file-templates-in-IDEA/right-click-new-entity.webp" alt="right click"></li>
<li>输入entity名，如<code>User</code>，首字母大写<br><img src="/img/in-post/file-templates-in-IDEA/input-entity.webp" alt="input entity"></li>
<li>生成的如下文件：<ul>
<li>entity/po : <code>User.java</code></li>
<li>dao : <code>UserRepository.java</code></li>
<li>service : <code>UserService.java</code></li>
<li>service/impl : <code>UserServiceImpl.java</code></li>
<li>controller : <code>UserController.java</code></li>
</ul>
</li>
</ol>
<p>对应的项目结构如下，下文的配置也是以这个结构为前提的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">src&#x2F;main&#x2F;java</span><br><span class="line">└── com.github.quanqinle</span><br><span class="line">        ├── Application.java</span><br><span class="line">        ├── entity</span><br><span class="line">        │   ├── po</span><br><span class="line">        │   │   └── User.java</span><br><span class="line">        │   └── vo</span><br><span class="line">        ├── dao</span><br><span class="line">        │   └── UserRepository.java</span><br><span class="line">        ├── service</span><br><span class="line">        │   ├── impl</span><br><span class="line">        │   │   └── UserServiceImpl.java</span><br><span class="line">        │   └── UserService.java</span><br><span class="line">        └── controller</span><br><span class="line">            └── UserController.java</span><br></pre></td></tr></table></figure>

<h1 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h1><p>先放一张最终的配置，就像下图中的(1)所示：</p>
<p><img src="/img/in-post/file-templates-in-IDEA/final-settings.webp" alt="final settings"></p>
<center style="color:#C0C0C0;">图1</center> 

<h2 id="配置po模板"><a href="#配置po模板" class="headerlink" title="配置po模板"></a>配置po模板</h2><p>打开<code>Settings</code>窗口，找到<code>Editor</code>——&gt;<code>File and Code templates</code>，在<code>Files</code>分类下，点击<kbd>Create Template</kbd>，即图1的按钮(2)</p>
<ul>
<li>Name：右键创建时看到的名字，例<code>Create whole classes in package root</code></li>
<li>Extension：默认的java</li>
<li>File Name：文件路径和文件名（不用加.java后缀），<code>./entity/po/${Subject}</code></li>
<li>输入模板内容，如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#set($SubjectOfLowerFirst = $&#123;Subject.substring(0,1).toLowerCase()&#125; + $Subject.substring(1))</span><br><span class="line">#if ($&#123;PACKAGE_NAME&#125; &amp;&amp; $&#123;PACKAGE_NAME&#125; != "")package $&#123;PACKAGE_NAME&#125;.entity.po;#end</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line">#parse("File Header.java")</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"$&#123;SubjectOfLowerFirst&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> $</span>&#123;Subject&#125; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"create_time"</span>)</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"update_time"</span>)</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置dao模板"><a href="#配置dao模板" class="headerlink" title="配置dao模板"></a>配置dao模板</h2><p>选中第一步创建的<kbd>Create Template</kbd>前提下，点击<kbd>Create Child Template File</kbd>，即图1的按钮(3)</p>
<ul>
<li>File Name：文件路径和文件名（不用加.java后缀），<code>./dao/${Subject}Repository</code></li>
<li>Extension：默认的java</li>
<li>输入模板内容，如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#set($SubjectOfLowerFirst = $&#123;Subject.substring(0,1).toLowerCase()&#125; + $Subject.substring(1))</span><br><span class="line">#if ($&#123;PACKAGE_NAME&#125; &amp;&amp; $&#123;PACKAGE_NAME&#125; != "")package $&#123;PACKAGE_NAME&#125;.dao;#end</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> $&#123;PACKAGE_NAME&#125;.entity.po.$&#123;Subject&#125;;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line">#parse("File Header.java")</span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> $</span>&#123;Subject&#125;Repository extends JpaRepository&lt;$&#123;Subject&#125;, Long&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置service模板"><a href="#配置service模板" class="headerlink" title="配置service模板"></a>配置service模板</h2><p>选中第一步创建的<kbd>Create Template</kbd>前提下，点击<kbd>Create Child Template File</kbd>，即图1的按钮(3)</p>
<ul>
<li>File Name：文件路径和文件名（不用加.java后缀），<code>./service/${Subject}Service</code></li>
<li>Extension：默认的java</li>
<li>输入模板内容，如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#set($SubjectOfLowerFirst = $&#123;Subject.substring(0,1).toLowerCase()&#125; + $Subject.substring(1))</span><br><span class="line">#if ($&#123;PACKAGE_NAME&#125; &amp;&amp; $&#123;PACKAGE_NAME&#125; != "")package $&#123;PACKAGE_NAME&#125;.service;#end</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> $&#123;PACKAGE_NAME&#125;.entity.po.$&#123;Subject&#125;;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line">#parse("File Header.java")</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> $</span>&#123;Subject&#125;Service &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * insert</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $&#123;SubjectOfLowerFirst&#125; a $&#123;Subject&#125; object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    $&#123;Subject&#125; insert($&#123;Subject&#125; $&#123;SubjectOfLowerFirst&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * update</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $&#123;SubjectOfLowerFirst&#125; a $&#123;Subject&#125; object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    $&#123;Subject&#125; update($&#123;Subject&#125; $&#123;SubjectOfLowerFirst&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * query by id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id $&#123;Subject&#125; id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Optional&lt;$&#123;Subject&#125;&gt; queryById(Long id);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * delete by id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id $&#123;Subject&#125; id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">deleteById</span><span class="params">(Long id)</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置service-implement模板"><a href="#配置service-implement模板" class="headerlink" title="配置service implement模板"></a>配置service implement模板</h2><p>选中第一步创建的<kbd>Create Template</kbd>前提下，点击<kbd>Create Child Template File</kbd>，即图1的按钮(3)</p>
<ul>
<li>File Name：文件路径和文件名（不用加.java后缀），<code>./service/impl/${Subject}ServiceImpl</code></li>
<li>Extension：默认的java</li>
<li>输入模板内容，如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#set($SubjectOfLowerFirst &#x3D; $&#123;Subject.substring(0,1).toLowerCase()&#125; + $Subject.substring(1))</span><br><span class="line">#if ($&#123;PACKAGE_NAME&#125; &amp;&amp; $&#123;PACKAGE_NAME&#125; !&#x3D; &quot;&quot;)package $&#123;PACKAGE_NAME&#125;.service.impl;#end</span><br><span class="line"></span><br><span class="line">import $&#123;PACKAGE_NAME&#125;.dao.$&#123;Subject&#125;Repository;</span><br><span class="line">import $&#123;PACKAGE_NAME&#125;.entity.po.$&#123;Subject&#125;;</span><br><span class="line">import $&#123;PACKAGE_NAME&#125;.service.$&#123;Subject&#125;Service;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line">import java.util.Optional;</span><br><span class="line"></span><br><span class="line">#parse(&quot;File Header.java&quot;)</span><br><span class="line">@Service</span><br><span class="line">@Transactional(rollbackFor &#x3D; Exception.class)</span><br><span class="line">public class $&#123;Subject&#125;ServiceImpl implements $&#123;Subject&#125;Service &#123;</span><br><span class="line"></span><br><span class="line">    private Logger log &#x3D; LoggerFactory.getLogger($&#123;Subject&#125;Service.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private $&#123;Subject&#125;Repository repository;</span><br><span class="line"></span><br><span class="line">    public $&#123;Subject&#125;ServiceImpl() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public $&#123;Subject&#125; insert($&#123;Subject&#125; $&#123;SubjectOfLowerFirst&#125;) &#123;</span><br><span class="line">        return repository.save($&#123;SubjectOfLowerFirst&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public $&#123;Subject&#125; update($&#123;Subject&#125; $&#123;SubjectOfLowerFirst&#125;) &#123;</span><br><span class="line">        return repository.save($&#123;SubjectOfLowerFirst&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean deleteById(Long id) &#123;</span><br><span class="line">        Boolean result &#x3D; true;</span><br><span class="line">        try &#123;</span><br><span class="line">            repository.deleteById(id);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            result &#x3D; false;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Optional&lt;$&#123;Subject&#125;&gt; queryById(Long id) &#123;</span><br><span class="line">        return repository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置controller模板"><a href="#配置controller模板" class="headerlink" title="配置controller模板"></a>配置controller模板</h2><p>选中第一步创建的<kbd>Create Template</kbd>前提下，点击<kbd>Create Child Template File</kbd>，即图1的按钮(3)</p>
<ul>
<li>File Name：文件路径和文件名（不用加.java后缀），<code>./controller/${Subject}Controller</code></li>
<li>Extension：默认的java</li>
<li>输入模板内容，如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#set($SubjectOfLowerFirst &#x3D; $&#123;Subject.substring(0,1).toLowerCase()&#125; + $Subject.substring(1))</span><br><span class="line">#if ($&#123;PACKAGE_NAME&#125; &amp;&amp; $&#123;PACKAGE_NAME&#125; !&#x3D; &quot;&quot;)package $&#123;PACKAGE_NAME&#125;.controller;#end</span><br><span class="line"></span><br><span class="line">import $&#123;PACKAGE_NAME&#125;.entity.Result;</span><br><span class="line">import $&#123;PACKAGE_NAME&#125;.entity.po.$&#123;Subject&#125;;</span><br><span class="line">import $&#123;PACKAGE_NAME&#125;.service.$&#123;Subject&#125;Service;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line">import javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line">#parse(&quot;File Header.java&quot;)</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;api&#x2F;$&#123;SubjectOfLowerFirst&#125;&quot;)</span><br><span class="line">public class $&#123;Subject&#125;Controller &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    private $&#123;Subject&#125;Service $&#123;SubjectOfLowerFirst&#125;Service;</span><br><span class="line"></span><br><span class="line">    @PostMapping</span><br><span class="line">    public Result&lt;$&#123;Subject&#125;&gt; create(@RequestBody $&#123;Subject&#125; record) &#123;</span><br><span class="line">        $&#123;Subject&#125; $&#123;SubjectOfLowerFirst&#125; &#x3D; $&#123;SubjectOfLowerFirst&#125;Service.insert(record);</span><br><span class="line">        return Result.success($&#123;SubjectOfLowerFirst&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @PutMapping</span><br><span class="line">    public Result&lt;$&#123;Subject&#125;&gt; update(@RequestBody $&#123;Subject&#125; record) &#123;</span><br><span class="line">        $&#123;Subject&#125; $&#123;SubjectOfLowerFirst&#125; &#x3D; $&#123;SubjectOfLowerFirst&#125;Service.update(record);</span><br><span class="line">        return Result.success($&#123;SubjectOfLowerFirst&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @DeleteMapping(&quot;&#123;id&#125;&quot;)</span><br><span class="line">    public Result&lt;Void&gt; deleteById(@PathVariable Long id) &#123;</span><br><span class="line">        boolean success &#x3D; $&#123;SubjectOfLowerFirst&#125;Service.deleteById(id);</span><br><span class="line">        return success ? Result.success() : Result.fail();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;&#123;id&#125;&quot;)</span><br><span class="line">    public Result&lt;$&#123;Subject&#125;&gt; queryById(@PathVariable Long id) &#123;</span><br><span class="line">        var optional &#x3D; $&#123;SubjectOfLowerFirst&#125;Service.queryById(id);</span><br><span class="line">        if (optional.isPresent()) &#123;</span><br><span class="line">            return Result.success(optional.get());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return Result.success();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存配置。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2021/02/06/use-easyexcel-to-read-excel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/06/use-easyexcel-to-read-excel/" class="post-title-link" itemprop="url">Java | 使用EasyExcel读取excel</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-07 00:00:00" itemprop="dateCreated datePublished" datetime="2021-02-07T00:00:00+08:00">2021-02-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-02-18 00:00:00" itemprop="dateModified" datetime="2021-02-18T00:00:00+08:00">2021-02-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="EasyExcel-？"><a href="#EasyExcel-？" class="headerlink" title="EasyExcel ？"></a>EasyExcel ？</h1><p>以前我都是用<code>Apache poi</code>解析Excel，但我不喜欢自己处理模型转换、数值类型转换，而且poi处理大excel时内存高。后来听说了阿里开源的EasyExcel，决定试用下。</p>
<p>官方如此自我介绍：</p>
<blockquote>
<p>快速、简单避免OOM的Java处理Excel工具</p>
<p>EasyExcel是一个基于Java的简单、省内存的读写Excel的开源项目。在尽可能节约内存的情况下支持读写百M的Excel。 github地址：<a href="https://github.com/alibaba/easyexcel" target="_blank" rel="noopener">https://github.com/alibaba/easyexcel</a></p>
</blockquote>
<h1 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h1><p>我的maven pom文件如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdk.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">jdk.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easyexcel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 以下非必须，视自己的实际情况决定是否引入 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="极简读Excel示例"><a href="#极简读Excel示例" class="headerlink" title="极简读Excel示例"></a>极简读Excel示例</h1><h2 id="1-数据类DemoBizExcelRow-java，存储excel一行的数据"><a href="#1-数据类DemoBizExcelRow-java，存储excel一行的数据" class="headerlink" title="1. 数据类DemoBizExcelRow.java，存储excel一行的数据"></a>1. 数据类<code>DemoBizExcelRow.java</code>，存储excel一行的数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> <span class="comment">// 使用lombok，或自己实现get/set</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoBizExcelRow</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String string;</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line">    <span class="keyword">private</span> Double doubleData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-自定义数据行监听类DemoDataListener-java，逐行解析数据"><a href="#2-自定义数据行监听类DemoDataListener-java，逐行解析数据" class="headerlink" title="2. 自定义数据行监听类DemoDataListener.java，逐行解析数据"></a>2. 自定义数据行监听类<code>DemoDataListener.java</code>，逐行解析数据</h2><p>如果想要获得解析结果集的话，可以像下面这样通过构造函数传参来接收。如果要在监听类里完成DB存储操作，可以参考官方示例<code>DemoDataListener.java</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoDataListener</span> <span class="keyword">extends</span> <span class="title">AnalysisEventListener</span>&lt;<span class="title">DemoBizExcelRow</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;DemoBizExcelRow&gt; list = <span class="keyword">new</span> ArrayList&lt;DemoBizExcelRow&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoDataListener</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果使用了spring，请使用这个构造方法。每次创建Listener的时候需要把spring管理的类传进来</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoDataListener</span><span class="params">(List&lt;DemoBizExcelRow&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个每一条数据解析都会来调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     *            one row value. Is is same as &#123;<span class="doctag">@link</span> AnalysisContext#readRowHolder()&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(DemoBizExcelRow data, AnalysisContext context)</span> </span>&#123;</span><br><span class="line">        list.add(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有数据解析完成了 都会来调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterAllAnalysed</span><span class="params">(AnalysisContext context)</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String file = <span class="string">"D:\\Demo.xlsx"</span>;</span><br><span class="line">List&lt;DemoExcelRow&gt; list = <span class="keyword">new</span> ArrayList&lt;DemoExcelRow&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    EasyExcel.read(file, DemoExcelRow<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">DemoDataListener</span>&lt;&gt;(<span class="title">list</span>))</span></span><br><span class="line"><span class="class">            .<span class="title">sheet</span>(0)</span></span><br><span class="line"><span class="class">            .<span class="title">headRowNumber</span>(1)</span></span><br><span class="line"><span class="class">            .<span class="title">doRead</span>()</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    LOGGER.error(<span class="string">"e=&#123;&#125;"</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用起来不复杂，自己只要做两件事：1.定义数据类 2.自定义监听（用于获取excel内容，或者完成dao操作等等）</p>
<h1 id="自定义读取Excel"><a href="#自定义读取Excel" class="headerlink" title="自定义读取Excel"></a>自定义读取Excel</h1><p>可是，在我自己的实际使用中，我还需要以下的功能：</p>
<ul>
<li>表头有多行，每类业务表excel还互不相同</li>
<li>获取表头数据，至少包括排序、列名</li>
<li>校验部分表头名，以确保excel符合要求，如不符，直接退出</li>
<li>解析时数据校验，比如，必填项不能为空，特定列的值不能超出某个范围，特定列值通过enum转换</li>
<li>获取每行中所有错误列集合，然而，官方默认行为是，遇到某个单元格有误的时候忽略剩余单元格，跳到下一行</li>
</ul>
<h2 id="1-返回结果类"><a href="#1-返回结果类" class="headerlink" title="1. 返回结果类"></a>1. 返回结果类</h2><p>上面的例子只返回了有效数据集合<code>List&lt;DemoExcelRow&gt;</code>，而现在想要a）有效数据 b）错误信息 c）表头信息，设计一个结果类处理起来更方便。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadExcelResult</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表头map。</span></span><br><span class="line"><span class="comment">     * 行index-&gt;表头整行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;Integer, Map&lt;Integer, CellData&gt;&gt; rowIdx2HeadMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有效数据map。</span></span><br><span class="line"><span class="comment">     * 行index-&gt;数据整行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;Integer, T&gt; rowIdx2RowDataMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误行列map。</span></span><br><span class="line"><span class="comment">     * 行index-&gt;错误列index</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;Integer, Set&lt;Integer&gt;&gt; rowIdx2ErrColIdxMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化变量，使之都不为空</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReadExcelResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rowIdx2HeadMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.rowIdx2RowDataMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.rowIdx2ErrColIdxMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-数据类DemoExcelRow-java"><a href="#2-数据类DemoExcelRow-java" class="headerlink" title="2. 数据类DemoExcelRow.java"></a>2. 数据类<code>DemoExcelRow.java</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> <span class="comment">// 使用lombok，或自己实现get/set</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoExcelRow</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表头所在行</span></span><br><span class="line"><span class="comment">     * 行号从1开始</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> HEAD_ROW_NUMBER = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 列数</span></span><br><span class="line"><span class="comment">     * index从0开始，last_index==列数-1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> COLUMN_LAST_NUMBER = <span class="number">37</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 期望的表头</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;主要用于表格合法性校验。这里可以只校验必要的字段，即，配置实际excel的表头字段的子集。&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;当为null时，不校验表头&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;key是表头排序，即columnIndex，从0开始；&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;value是表头名，可以忽略前后空格，但必须包含中间空格和换行&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;Integer, String&gt; HEAD_CHECK_MAP = <span class="keyword">new</span> HashMap&lt;&gt;() &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            put( <span class="number">0</span>, <span class="string">"索引号"</span>);</span><br><span class="line">            put( <span class="number">1</span>, <span class="string">"选取样本特征"</span>);</span><br><span class="line">            put( <span class="number">2</span>, <span class="string">"发函单位（客户）*"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---- 以下是表格一一对应的字段 ---- */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty</span>(&#123;<span class="string">"索引号"</span>&#125;)</span><br><span class="line">    <span class="keyword">private</span> String string;</span><br><span class="line">    <span class="meta">@ExcelProperty</span>(value = <span class="string">"会计科目"</span>, converter = SubjectConverter<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">String</span> <span class="title">subject</span></span>;</span><br><span class="line">    <span class="meta">@ExcelProperty</span>(<span class="string">"存款日期"</span>)</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line">    <span class="meta">@ExcelProperty</span>(index = <span class="number">5</span>)</span><br><span class="line">    <span class="meta">@NumberFormat</span>(<span class="string">"#.##"</span>)</span><br><span class="line">    <span class="keyword">private</span> Double doubleData;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getHeadRowNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HEAD_ROW_NUMBER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getColumnLastNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> COLUMN_LAST_NUMBER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Integer, String&gt; <span class="title">getHeadCheckMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HEAD_CHECK_MAP;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解读：</p>
<ul>
<li>变量<code>subject</code>一个转换器，下面会说</li>
<li>变量<code>doubleData</code>通过注解<code>@NumberFormat(&quot;#.##&quot;)</code>指定两位小数，通过<code>@ExcelProperty(index = 5)</code>设定它在第6列</li>
<li>默认所有字段都会和excel匹配，通过<code>@ExcelIgnore</code>说明某变量不是excel中的字段</li>
<li><code>HEAD_ROW_NUMBER</code>真正的表头所在行</li>
<li><code>HEAD_CHECK_MAP</code>用于表头校验的map</li>
</ul>
<h2 id="3-转换器"><a href="#3-转换器" class="headerlink" title="3. 转换器"></a>3. 转换器</h2><p>转换器<code>SubjectConverter.java</code>将excel中的文本转成enum中的1、2、3，如本例中，读到”应收账款”转存为16。</p>
<p>下面的代码只有<code>convertToJavaData()</code>被修改了，其他都是继承来的，IDE会自动生成，所以这部分不写了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略了一些代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 往来明细表 往来账项列示  会计科目</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;String, Integer&gt; CONTACT_SUBJECT_MAP = <span class="keyword">new</span> HashMap&lt;&gt;() &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            put(<span class="string">"应收账款"</span>,<span class="number">16</span>);</span><br><span class="line">            put(<span class="string">"预收款项"</span>,<span class="number">17</span>);</span><br><span class="line">            put(<span class="string">"应付账款"</span>,<span class="number">18</span>);</span><br><span class="line">            put(<span class="string">"预付款项"</span>,<span class="number">19</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Convert excel objects to Java objects</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cellData            Excel cell data.NotNull.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentProperty     Content property.Nullable.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> globalConfiguration Global configuration.NotNull.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Data to put into a Java object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception Exception.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">convertToJavaData</span><span class="params">(CellData cellData, ExcelContentProperty contentProperty, GlobalConfiguration globalConfiguration)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String key = cellData.getStringValue();</span><br><span class="line">        Integer val = CONTACT_SUBJECT_MAP.get(key);</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"fail to convert 会计科目: "</span> + key, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> val.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-自定义单元格解析的监听"><a href="#4-自定义单元格解析的监听" class="headerlink" title="4. 自定义单元格解析的监听"></a>4. 自定义单元格解析的监听</h2><p><code>ReadAllCellDataThrowExceptionLastListener.java</code>类照搬了官方<code>ModelBuildEventListener.java</code>，只是将其中遇到错误格中止当前行剩余内容，改成了遇到错误不中止继续读完整行。</p>
<p>下面只写出被修改的函数，相同部分不写了，直接在<code>ModelBuildEventListener.java</code>里抄了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadAllCellDataThrowExceptionLastListener</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">        <span class="title">AbstractIgnoreExceptionReadListener</span>&lt;<span class="title">Map</span>&lt;<span class="title">Integer</span>, <span class="title">CellData</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略了一些代码</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">buildUserModel</span><span class="params">(Map&lt;Integer, CellData&gt; cellDataMap, ReadHolder currentReadHolder,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  AnalysisContext context)</span> </span>&#123;</span><br><span class="line">        ExcelReadHeadProperty excelReadHeadProperty = currentReadHolder.excelReadHeadProperty();</span><br><span class="line">        Object resultModel;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resultModel = excelReadHeadProperty.getHeadClazz().getDeclaredConstructor().newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExcelDataConvertException(context.readRowHolder().getRowIndex(), <span class="number">0</span>,</span><br><span class="line">                    <span class="keyword">new</span> CellData(CellDataTypeEnum.EMPTY), <span class="keyword">null</span>,</span><br><span class="line">                    <span class="string">"Can not instance class: "</span> + excelReadHeadProperty.getHeadClazz().getName(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;Integer, Head&gt; headMap = excelReadHeadProperty.getHeadMap();</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(headMap.size() * <span class="number">4</span> / <span class="number">3</span> + <span class="number">1</span>);</span><br><span class="line">        Map&lt;Integer, ExcelContentProperty&gt; contentPropertyMap = excelReadHeadProperty.getContentPropertyMap();</span><br><span class="line">        LinkedList&lt;ExcelDataConvertException&gt; exceptionLinkedList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, Head&gt; entry : headMap.entrySet()) &#123;</span><br><span class="line">            Integer index = entry.getKey();</span><br><span class="line">            <span class="keyword">if</span> (!cellDataMap.containsKey(index)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            CellData cellData = cellDataMap.get(index);</span><br><span class="line">            <span class="keyword">if</span> (cellData.getType() == CellDataTypeEnum.EMPTY) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ExcelContentProperty excelContentProperty = contentPropertyMap.get(index);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object value = ConverterUtils.convertToJavaObject(cellData, excelContentProperty.getField(),</span><br><span class="line">                        excelContentProperty, currentReadHolder.converterMap(), currentReadHolder.globalConfiguration(),</span><br><span class="line">                        context.readRowHolder().getRowIndex(), index);</span><br><span class="line">                <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    map.put(excelContentProperty.getField().getName(), value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExcelDataConvertException e) &#123;</span><br><span class="line">                exceptionLinkedList.add(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(exceptionLinkedList)) &#123;</span><br><span class="line">            <span class="comment">//没有异常，则转换为需要的map</span></span><br><span class="line">            BeanMap.create(resultModel).putAll(map);</span><br><span class="line">            <span class="keyword">return</span> resultModel;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//存在异常，挨个抛出，最后一个异常往外抛结束运行</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; exceptionLinkedList.size(); i++) &#123;</span><br><span class="line">                ExcelDataConvertException exception = exceptionLinkedList.get(i);</span><br><span class="line">                <span class="keyword">if</span> (i == exceptionLinkedList.size() - <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// 最后</span></span><br><span class="line">                    <span class="keyword">throw</span> exception;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    handleException(context, exception);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(AnalysisContext analysisContext, Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (ReadListener readListenerException : analysisContext.currentReadHolder().readListenerList()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                readListenerException.onException(e, analysisContext);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException re) &#123;</span><br><span class="line">                <span class="keyword">throw</span> re;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ExcelAnalysisException(e1.getMessage(), e1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-自定义数据行解析的监听"><a href="#5-自定义数据行解析的监听" class="headerlink" title="5. 自定义数据行解析的监听"></a>5. 自定义数据行解析的监听</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBizDemoListener</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AnalysisEventListener</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 期望的表头</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;用于表格合法性校验。这里可以只校验必要的字段，即，配置实际excel的表头字段的子集。&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;当为null时，不校验表头&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;key是表头排序，即columnIndex，从0开始；&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;value是表头名，可以忽略前后空格，但必须包含中间空格和换行&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;Integer, String&gt; headCheckMap;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取excel后，存入该对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> ReadExcelResult&lt;T&gt; readExcelResult;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表头行/列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;Integer, Map&lt;Integer, CellData&gt;&gt; rowIdx2HeadMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有效行/列信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;Integer, T&gt; rowIdx2RowDataMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误行/列信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;Integer, Set&lt;Integer&gt;&gt; rowIdx2ErrColIdxMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前行的错误列index集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Set&lt;Integer&gt; currentRowErrorColumnIndexSet;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBizDemoListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> ReadExcelResult&lt;&gt;(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> readExcelResult 读取excel后，存入该对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headCheckMap    表格头校验map。A map contains columnIndex&lt;-&gt;表头名. If null, do not check head</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBizDemoListener</span><span class="params">(ReadExcelResult&lt;T&gt; readExcelResult, Map&lt;Integer, String&gt; headCheckMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.readExcelResult = readExcelResult;</span><br><span class="line">        <span class="keyword">this</span>.headCheckMap = headCheckMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理表头</span></span><br><span class="line"><span class="comment">     * 一行一行调用该函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headMap -</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context -</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invokeHead</span><span class="params">(Map&lt;Integer, CellData&gt; headMap, AnalysisContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.invokeHead(headMap, context);</span><br><span class="line"></span><br><span class="line">        ReadRowHolder readRowHolder = context.readRowHolder();</span><br><span class="line">        <span class="keyword">int</span> rowIndex = readRowHolder.getRowIndex();</span><br><span class="line"></span><br><span class="line">        rowIdx2HeadMap.put(rowIndex, headMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 表头合法性校验</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (headCheckMap != <span class="keyword">null</span> &amp;&amp; !headCheckMap.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">int</span> headRowNumber = context.readSheetHolder().getHeadRowNumber();</span><br><span class="line">            <span class="keyword">if</span> (headRowNumber == rowIndex + <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Integer key : headCheckMap.keySet()) &#123;</span><br><span class="line">                    String expect = headCheckMap.get(key).trim();</span><br><span class="line">                    CellData cell = headMap.get(key);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == cell) &#123;</span><br><span class="line">                        <span class="comment">//模板不符！退出</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ExcelHeadException(<span class="string">"表头与预期不符。未找到表头："</span> + expect);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    String real = cell.getStringValue();</span><br><span class="line">                    real = (real==<span class="keyword">null</span>? <span class="keyword">null</span> : real.trim());</span><br><span class="line">                    <span class="keyword">if</span> (!expect.equalsIgnoreCase(real)) &#123;</span><br><span class="line">                        <span class="comment">//模板不符！退出</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ExcelHeadException(<span class="string">"表头与预期不符。期望："</span> + expect + <span class="string">" &lt;--&gt; 实际："</span> + real);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * When analysis one row trigger invoke function.</span></span><br><span class="line"><span class="comment">     * 自动跳过空行，即，空行不会进入这个函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    one row value. Is is same as &#123;<span class="doctag">@link</span> AnalysisContext#readRowHolder()&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context -</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(T data, AnalysisContext context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        currentRowErrorColumnIndexSet = <span class="keyword">new</span> TreeSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        ReadRowHolder readRowHolder = context.readRowHolder();</span><br><span class="line">        <span class="keyword">int</span> rowIndex = readRowHolder.getRowIndex();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 非空校验方法。业务强相关，略去源码。可以通过特定的注解判断必填</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ReadExcelUtil.checkNotEmpty(data, context, currentRowErrorColumnIndexSet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 值有效性校验。业务强相关，略去源码</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ReadExcelUtil.checkFieldValueInStringMap(data, <span class="string">"sendType"</span>, ReadExcelConstant.SEND_TYPE_MAP, context, currentRowErrorColumnIndexSet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentRowErrorColumnIndexSet.isEmpty()) &#123;</span><br><span class="line">            rowIdx2RowDataMap.put(rowIndex, data);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Set&lt;Integer&gt; errColIdxMap = rowIdx2ErrColIdxMap.get(rowIndex);</span><br><span class="line">            <span class="keyword">if</span> (errColIdxMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">                currentRowErrorColumnIndexSet.addAll(errColIdxMap);</span><br><span class="line">            &#125;</span><br><span class="line">            rowIdx2ErrColIdxMap.put(rowIndex, currentRowErrorColumnIndexSet);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * if have something to do after all analysis</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context -</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterAllAnalysed</span><span class="params">(AnalysisContext context)</span> </span>&#123;</span><br><span class="line">        readExcelResult.setRowIdx2HeadMap(rowIdx2HeadMap);</span><br><span class="line">        readExcelResult.setRowIdx2ErrColIdxMap(rowIdx2ErrColIdxMap);</span><br><span class="line">        readExcelResult.setRowIdx2RowDataMap(rowIdx2RowDataMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The current method is called when extra information is returned</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extra   extra information</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context -</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">extra</span><span class="params">(CellExtra extra, AnalysisContext context)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * All listeners receive this method when any one Listener does an error report. If an exception is thrown here, the</span></span><br><span class="line"><span class="comment">     * entire read will terminate.</span></span><br><span class="line"><span class="comment">     * 获取其他异常下会调用本接口。抛出异常则停止读取。如果这里不抛出异常则 继续读取下一行。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exception -</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context -</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Exception exception, AnalysisContext context)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是某一个单元格的转换异常，能获取到具体行号</span></span><br><span class="line">        <span class="comment">// 如果要获取头的信息，配合invokeHeadMap使用</span></span><br><span class="line">        <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> ExcelDataConvertException) &#123;</span><br><span class="line">            ExcelDataConvertException excelDataConvertException = (ExcelDataConvertException)exception;</span><br><span class="line">            Integer cellRowIndex = excelDataConvertException.getRowIndex();</span><br><span class="line">            Integer cellColumnIndex = excelDataConvertException.getColumnIndex();</span><br><span class="line"></span><br><span class="line">            String cellColumnString = CellReference.convertNumToColString(cellColumnIndex);</span><br><span class="line">            LOGGER.error(<span class="string">"第&#123;&#125;行&#123;&#125;列，数值转换异常：&#123;&#125;"</span>, cellRowIndex+<span class="number">1</span>, cellColumnString, exception.getMessage());</span><br><span class="line"></span><br><span class="line">            Set&lt;Integer&gt; errColIdxMap = rowIdx2ErrColIdxMap.get(cellRowIndex);</span><br><span class="line">            <span class="keyword">if</span> (errColIdxMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                errColIdxMap = <span class="keyword">new</span> TreeSet&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            errColIdxMap.add(cellColumnIndex);</span><br><span class="line">            rowIdx2ErrColIdxMap.put(cellRowIndex, errColIdxMap);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> ExcelHeadException) &#123;</span><br><span class="line"></span><br><span class="line">            LOGGER.error(exception.getMessage());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 表格不符合规范，抛出异常，触发终止解析</span></span><br><span class="line">            <span class="keyword">throw</span> exception;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"第&#123;&#125;行解析失败，但是继续解析下一行。exception: \n&#123;&#125;"</span>,</span><br><span class="line">                    context.readRowHolder().getRowIndex() + <span class="number">1</span>,</span><br><span class="line">                    Arrays.toString(exception.getStackTrace()).replaceAll(<span class="string">","</span>, <span class="string">"\n"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解读：</p>
<ul>
<li>在<code>invokeHead()</code>中，借助构造函数传入的变量<code>headCheckMap</code>校验excel表头</li>
<li>在<code>onException()</code>中，仅当<code>throw exception</code>时才会终止excel解析，否则只是跳过到下一行</li>
<li>在<code>invoke()</code>中，处理必填项、数值合法性校验等等</li>
</ul>
<h2 id="6-使用"><a href="#6-使用" class="headerlink" title="6. 使用"></a>6. 使用</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">String file = <span class="string">"D:\\Demo.xlsx"</span>;</span><br><span class="line"></span><br><span class="line">ReadExcelResult&lt;DemoBizExcelRow&gt; readExcelResult = <span class="keyword">new</span> ReadExcelResult&lt;&gt;();</span><br><span class="line">ExcelReader excelReader = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    MyBizDemoListener&lt;DemoBizExcelRow&gt; myBizDemoListener = <span class="keyword">new</span> MyBizDemoListener&lt;&gt;(readExcelResult, DemoBizExcelRow.getHeadCheckMap());</span><br><span class="line">    excelReader = EasyExcel.read(file, DemoBizExcelRow<span class="class">.<span class="keyword">class</span>, <span class="title">null</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">useDefaultListener</span>(<span class="title">false</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">registerReadListener</span>(<span class="title">new</span> <span class="title">ReadAllCellDataThrowExceptionLastListener</span>())</span></span><br><span class="line"><span class="class">            .<span class="title">registerReadListener</span>(<span class="title">myBizDemoListener</span>)</span></span><br><span class="line"><span class="class">            .<span class="title">build</span>()</span>;</span><br><span class="line">    ReadSheet readSheet = EasyExcel.readSheet(<span class="number">0</span>).headRowNumber(DemoBizExcelRow.getHeadRowNumber()).build();</span><br><span class="line">    excelReader.read(readSheet);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ExcelHeadException) &#123;</span><br><span class="line">        LOGGER.error(<span class="string">"Excel模板错误！"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOGGER.error(<span class="string">"其他异常"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (excelReader != <span class="keyword">null</span>) &#123;</span><br><span class="line">        excelReader.finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印 readExcelResult</span></span><br></pre></td></tr></table></figure>
<p>解读：</p>
<ul>
<li><code>EasyExcel</code>默认提供了解析单元格的监听（即上面提到的<code>ModelBuildEventListener.java</code>），如果要使用自定义的单元格解析监听，要先去掉默认<code>useDefaultListener(false)</code>，再注册自己的<code>registerReadListener(new ReadAllCellDataThrowExceptionLastListener())</code></li>
<li>在使用自定义单元格解析监听情况下，不能通过<code>EasyExcel.read()</code>传入自定义的行解析监听，只能通过<code>registerReadListener()</code>注册，并且，（这一点很重要）<strong>要放在注册自定义单元格监听之后</strong>。</li>
</ul>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><h2 id="格式转换"><a href="#格式转换" class="headerlink" title="格式转换"></a>格式转换</h2><h3 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExcelProperty</span>(<span class="string">"开始时间"</span>)</span><br><span class="line"><span class="meta">@DateTimeFormat</span>(<span class="string">"yyyy-MM-dd"</span>)</span><br><span class="line"><span class="keyword">private</span> Date startTime;</span><br></pre></td></tr></table></figure>
<ul>
<li>2020/1/2 –&gt; 1577894400000（即，2020-01-02）</li>
<li>你好 –&gt; throw new Exception()</li>
<li>// 转换失败时，会抛异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExcelProperty</span>(<span class="string">"结束时间"</span>)</span><br><span class="line"><span class="meta">@DateTimeFormat</span>(<span class="string">"yyyy-MM-dd"</span>)</span><br><span class="line"><span class="keyword">private</span> String endTime;</span><br></pre></td></tr></table></figure>
<ul>
<li>2019/2/5 –&gt; 2019-02-05</li>
<li>你好 –&gt; 你好</li>
<li>// 转换失败时，保持原值，不会抛异常</li>
</ul>
<h3 id="数值"><a href="#数值" class="headerlink" title="数值"></a>数值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExcelProperty</span>(<span class="string">"存钱"</span>)</span><br><span class="line"><span class="meta">@NumberFormat</span>(<span class="string">"#.##"</span>)</span><br><span class="line"><span class="keyword">private</span> Double deposit;</span><br></pre></td></tr></table></figure>
<ul>
<li>1.2345 –&gt; 1.23</li>
<li>你好 –&gt; throw new Exception()</li>
<li>// 转换失败时，会异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExcelProperty</span>(<span class="string">"取钱"</span>)</span><br><span class="line"><span class="meta">@NumberFormat</span>(<span class="string">"#.##"</span>)</span><br><span class="line"><span class="keyword">private</span> String withdraw;</span><br></pre></td></tr></table></figure>
<ul>
<li>1.2345 –&gt; 1.23</li>
<li>你好 –&gt; 你好</li>
<li>// 转换失败时，保持原值，不会抛异常</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2020/12/20/Raspberry4b/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/20/Raspberry4b/" class="post-title-link" itemprop="url">Raspberry | 树莓派4b系统安装、配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-21 00:00:00" itemprop="dateCreated datePublished" datetime="2020-12-21T00:00:00+08:00">2020-12-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-29 00:00:00" itemprop="dateModified" datetime="2020-12-29T00:00:00+08:00">2020-12-29</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="购买树莓派的原因"><a href="#购买树莓派的原因" class="headerlink" title="购买树莓派的原因"></a>购买树莓派的原因</h1><ul>
<li>家里没有NAS，想随时访问那几块闲置的移动硬盘不方便</li>
<li>给小米电视额外增加一个输入源</li>
<li>希望从外网访问家里的网络</li>
<li>通过树莓派下载视频到移动硬盘</li>
</ul>
<h1 id="硬件情况"><a href="#硬件情况" class="headerlink" title="硬件情况"></a>硬件情况</h1><ul>
<li>2020年产 Raspberry 4b，内存4G</li>
<li>32G TF存储卡</li>
<li>安装系统、配置过程中，树莓派不外接 键盘、鼠标、显示器</li>
<li>存储卡插入笔记本</li>
<li>树莓派连接笔记本提供的无线热点</li>
<li>在笔记本上，ssh连接树莓派完成安装配置操作</li>
</ul>
<h1 id="选择系统"><a href="#选择系统" class="headerlink" title="选择系统"></a>选择系统</h1><p>网上看了一些文章说，4G内存的树莓派运行64位系统完全没问题，所以，我选择了64位系统。</p>
<p>先是尝试安装了<code>Ubuntu 64位LST版</code>（<a href="https://ubuntu.com/download/raspberry-pi" target="_blank" rel="noopener">安装包</a>），过程很不顺利，放弃了。</p>
<p>最终安装的<code>官方64位版OS</code>。</p>
<p>所以，先在笔记本上下载<a href="https://downloads.raspberrypi.org/raspios_arm64/images/" target="_blank" rel="noopener">raspios_arm64 zip包</a>。</p>
<h1 id="写入OS"><a href="#写入OS" class="headerlink" title="写入OS"></a>写入OS</h1><p>官方提供的烧录OS工具 <a href="https://www.raspberrypi.org/software/" target="_blank" rel="noopener">Raspberry Pi Imager</a> 非常简单、易用，但是，对于我来说不适用，原因是其一它没有提供官方的64位系统，其二使用这种方法的话，我没有找到在不外接键盘、鼠标情况下，访问系统的方法。</p>
<p>我使用的工具是<a href="https://www.raspberrypi.org/documentation/installation/installing-images/windows.md" target="_blank" rel="noopener">Win32DiskImager</a>，将系统zip写入存储卡。</p>
<h1 id="预配置"><a href="#预配置" class="headerlink" title="预配置"></a>预配置</h1><p>在笔记本上打开存储卡，在boot目录下</p>
<ul>
<li>开启ssh访问：新建空文件<code>ssh</code></li>
<li>配置热点连接：新建<code>wpa_supplicant.conf</code>文件，内容如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ctrl_interface&#x3D;DIR&#x3D;&#x2F;var&#x2F;run&#x2F;wpa_supplicant GROUP&#x3D;netdev</span><br><span class="line">update_config&#x3D;1</span><br><span class="line">country&#x3D;CN</span><br><span class="line">ap_scan&#x3D;1</span><br><span class="line">fast_reauth&#x3D;1</span><br><span class="line"></span><br><span class="line">network&#x3D;&#123;</span><br><span class="line">  ssid&#x3D;&quot;hotspot-name-on-your-pc&quot;</span><br><span class="line">  psk&#x3D;&quot;hotspot-password&quot;</span><br><span class="line">  priority&#x3D;1</span><br><span class="line">  id_str&#x3D;&quot;hotspot&quot;</span><br><span class="line">&#125;</span><br><span class="line">network&#x3D;&#123;</span><br><span class="line">  ssid&#x3D;&quot;wifi-name&quot;</span><br><span class="line">  psk&#x3D;&quot;wifi-password&quot;</span><br><span class="line">  priority&#x3D;2</span><br><span class="line">  id_str&#x3D;&quot;home5g&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>官方对无线网配置的讲解：<br><a href="https://www.raspberrypi.org/documentation/configuration/wireless/headless.md" target="_blank" rel="noopener">https://www.raspberrypi.org/documentation/configuration/wireless/headless.md</a><br><a href="https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md" target="_blank" rel="noopener">https://www.raspberrypi.org/documentation/configuration/wireless/wireless-cli.md</a></p>
<p>注意：psk加双引号直接写明文密码，不加双引号则需要转换成32位预加密<code>wpa_passphrase &quot;your pasword&quot;</code></p>
<h1 id="启动Pi"><a href="#启动Pi" class="headerlink" title="启动Pi"></a>启动Pi</h1><p>先将内存卡插入树莓派，再插入电源后，树莓派将会自动启动。</p>
<h1 id="登录Pi"><a href="#登录Pi" class="headerlink" title="登录Pi"></a>登录Pi</h1><p>在热点管理or路由器管理界面，查找树莓派的IP。</p>
<p><code>ssh</code>访问树莓派：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh pi@IP-of-raspberry</span><br></pre></td></tr></table></figure>
<p>树莓派官方系统的默认登录名和密码是<code>pi / raspberry</code>。</p>
<h1 id="apt改国内源"><a href="#apt改国内源" class="headerlink" title="apt改国内源"></a>apt改国内源</h1><p>本想换成国内的源，尝试了阿里和清华的源，暂时都不支持arm64位，所以，使用默认的吧。如果嫌慢可以挂vpn，会好很多。</p>
<h1 id="pip-pip3改国内源"><a href="#pip-pip3改国内源" class="headerlink" title="pip/pip3改国内源"></a>pip/pip3改国内源</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~&#x2F;.pip</span><br><span class="line">vi ~&#x2F;.pip&#x2F;pip.conf</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line">timeout&#x3D;100</span><br><span class="line">index-url&#x3D;http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;pypi&#x2F;simple&#x2F;</span><br><span class="line">extra-index-url&#x3D;https:&#x2F;&#x2F;pypi.tuna.tsinghua.edu.cn&#x2F;simple&#x2F;</span><br><span class="line">[install]</span><br><span class="line">trusted-host&#x3D;</span><br><span class="line">    mirrors.aliyun.com</span><br><span class="line">    pypi.tuna.tsinghua.edu.cn</span><br></pre></td></tr></table></figure>

<h1 id="配置：开启VNC、设置分辨率，等"><a href="#配置：开启VNC、设置分辨率，等" class="headerlink" title="配置：开启VNC、设置分辨率，等"></a>配置：开启VNC、设置分辨率，等</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo raspi-config</span><br></pre></td></tr></table></figure>
<p>使用方向键控制光标，Enter键选择：</p>
<ul>
<li>在<code>Interfacing Options</code>中，找到<code>VNC</code>，选择<code>Yes</code></li>
<li>在<code>Boot Options</code>中，找到<code>Desktop/CLI</code>，选择<code>Desktop Autologin</code></li>
<li>在<code>Advanced Options</code>中，找到<code>Resolution</code>，选择<code>1920*1080</code></li>
<li>在<code>Advanced Options</code>中，选择<code>Expand Filesystem</code></li>
<li>通过<code>Tab</code>键，选择<code>Finish</code>，<code>Enter</code>触发reboot</li>
</ul>
<p>至此，树莓派配置完毕，重启后就可以vnc访问了，也可以连到电视上了。</p>
<h1 id="【可选】安装aria"><a href="#【可选】安装aria" class="headerlink" title="【可选】安装aria"></a>【可选】安装aria</h1><p>安装如下内容：</p>
<ul>
<li>aria</li>
<li>AriaNg：前端web管理界面，推荐使用<a href="https://github.com/mayswind/AriaNg/releases" target="_blank" rel="noopener">All in One包</a></li>
</ul>
<p>开始时，使用<code>sudo apt install aria2</code>，自己修改配置，可惜下载速度不理想。然后，改用了git上的一个热门项目<a href="https://github.com/P3TERX/aria2.sh" target="_blank" rel="noopener">“Aria2一键安装管理脚本（增强版）”</a></p>
<p>安装成功后，重现运行脚本，完成如下配置：</p>
<ul>
<li>选择<code>修改 配置</code>，再<code>修改 Aria2 下载目录</code></li>
<li>开启<code>自动更新 BT-Tracker</code></li>
</ul>
<p>此时，打开AriaNg网页，<code>Aria2 状态</code>一直显示“连接中”，并且，错误弹窗提示：认证失败!</p>
<blockquote>
<p>解决办法</p>
<ol>
<li>打开配置文件<code>/root/.aria2c/aria2.conf</code>，找到<code>rpc-secret=</code>复制其内容</li>
<li>在web中，打开<code>AriaNg 设置——RPC (localhost:6800)</code>，粘贴“Aria2 RPC 密钥”。该页面的url示例，形如，<a href="http://loclhost/AriaNg/index.html#!/settings/ariang" target="_blank" rel="noopener">http://loclhost/AriaNg/index.html#!/settings/ariang</a></li>
</ol>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2020/09/07/useful-JS-utils-in-Selenium/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/07/useful-JS-utils-in-Selenium/" class="post-title-link" itemprop="url">Selenium | 借助JavaScript实现一些不易处理的操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-08 00:00:00" itemprop="dateCreated datePublished" datetime="2020-09-08T00:00:00+08:00">2020-09-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="JavascriptExecutor"><a href="#JavascriptExecutor" class="headerlink" title="JavascriptExecutor"></a>JavascriptExecutor</h1><p>Javascript脚本执行器。</p>
<p><code>arguments[i]</code>是js脚本传参的占位符，i从0开始。</p>
<h1 id="页面滚动"><a href="#页面滚动" class="headerlink" title="页面滚动"></a>页面滚动</h1><p>jse方式滚动页面的几种方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">JavascriptExecutor jse = (JavascriptExecutor)driver;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 滚动到某元素（tips：适用于元素不可见或被遮挡）</span></span><br><span class="line">jse.executeScript(<span class="string">"arguments[0].scrollIntoView();"</span>, element);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向下滚动</span></span><br><span class="line">jse.executeScript(<span class="string">"window.scrollBy(0, 500)"</span>, <span class="string">""</span>);</span><br><span class="line">jse.executeScript(<span class="string">"scroll(0, 500);"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 滚动到底部</span></span><br><span class="line">jse.executeScript(<span class="string">"window.scrollTo(0, document.body.scrollHeight)"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态元素的高度</span></span><br><span class="line"><span class="keyword">double</span> ImageHeight = eachtile.getSize().getHeight();</span><br><span class="line"><span class="keyword">double</span> f = <span class="number">1.04</span>*ImageHeight;</span><br><span class="line">((JavascriptExecutor)driver).executeScript(<span class="string">"window.scrollBy(0,arguments[0]);"</span>, -f);</span><br></pre></td></tr></table></figure>


<h1 id="元素内取值"><a href="#元素内取值" class="headerlink" title="元素内取值"></a>元素内取值</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class&#x3D;&quot;item-price&quot;&gt;700 Yuan&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class&#x3D;&quot;item-price&quot;&gt;</span><br><span class="line">  &lt;span&gt;500 Yuan&lt;&#x2F;span&gt;</span><br><span class="line">  400 Yuan</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<p>div可能有span也可能没有，但要不取出span中的文本，即，期望得到700 Yuan和400 Yuan</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WebElement element = driver.findElement(By.xpath(<span class="string">"//div[contains(@class, 'item-price')]"</span>));</span><br><span class="line"></span><br><span class="line">JavascriptExecutor jse = (JavascriptExecutor)driver;</span><br><span class="line">jse.executeScript(<span class="string">"return arguments[0].lastChild.textContent;"</span>, element);</span><br></pre></td></tr></table></figure>


<h1 id="list超长，点击其中“不可见”的选项"><a href="#list超长，点击其中“不可见”的选项" class="headerlink" title="list超长，点击其中“不可见”的选项"></a>list超长，点击其中“不可见”的选项</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectListByJS</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JavascriptExecutor js = (JavascriptExecutor) driver;</span><br><span class="line">    String css;</span><br><span class="line">    css = <span class="string">"document.querySelectorAll('.select-menu')[0].querySelector('.select-option:nth-child(24)').click();"</span>;</span><br><span class="line">    js.executeScript(css);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改属性，使可见。</span></span><br><span class="line"><span class="comment">// tip：还没验证过</span></span><br><span class="line">String strJs = <span class="string">"document.getElementsByClassName('arguments[0]').style.height='auto'; document.getElementsByClassName('arguments[0]').style.visibility='visible';"</span>;</span><br></pre></td></tr></table></figure>

<h1 id="点击元素"><a href="#点击元素" class="headerlink" title="点击元素"></a>点击元素</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过JavaScript实现点击元素。</span></span><br><span class="line"><span class="comment"> * tips：适用于click()失效时</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> element</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clickByJS</span><span class="params">(WebElement element)</span> </span>&#123;</span><br><span class="line">	JavascriptExecutor jse = (JavascriptExecutor)driver;</span><br><span class="line">	jse.executeScript(<span class="string">"arguments[0].click()"</span>, element);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p><a href="https://www.guru99.com/execute-javascript-selenium-webdriver.html" target="_blank" rel="noopener">https://www.guru99.com/execute-javascript-selenium-webdriver.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2020/08/13/JUnit-Parameterized-Test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/13/JUnit-Parameterized-Test/" class="post-title-link" itemprop="url">JUnit | 参数化测试用例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-14 00:00:00" itemprop="dateCreated datePublished" datetime="2020-08-14T00:00:00+08:00">2020-08-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<p>在JUnit5中，可以将<code>@Test</code>替换成<code>@ParameterizedTest</code>，这样就可以使用不同的参数、多次循环运行测试方法。</p>
<h1 id="ValueSource"><a href="#ValueSource" class="headerlink" title="@ValueSource"></a><code>@ValueSource</code></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DisplayName</span>(<span class="string">"this is demo 1"</span>)</span><br><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="meta">@ValueSource</span>(ints = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Demo1</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> expected = <span class="number">2</span>;</span><br><span class="line">    assertEquals(expected, arg, <span class="string">"You are not such 2"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DisplayName</span>(<span class="string">"this is demo 2"</span>)</span><br><span class="line"><span class="meta">@ParameterizedTest</span>(name = <span class="string">"&#123;index&#125; ==&gt; the testcase is running"</span>)</span><br><span class="line"><span class="meta">@ValueSource</span>(strings = &#123;<span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3,4"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Demo2</span><span class="params">(String arg)</span> </span>&#123;</span><br><span class="line">    assertNull(arg, <span class="string">"不应空虚"</span>);</span><br><span class="line"></span><br><span class="line">    String expected = <span class="string">"2"</span>;</span><br><span class="line">    assertEquals(expected, arg, <span class="string">"You are not such 2"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>@ValueSource</code>中，可以使用strings、ints等等。但是，我个人更<strong>倾向于使用strings</strong>，因为String可以隐式转换为很多格式，这样传参更灵活一些。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="meta">@ValueSource</span>(strings = &#123;<span class="string">"true"</span>, <span class="string">"false"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Demo3</span><span class="params">(<span class="keyword">boolean</span> arg)</span> </span>&#123;</span><br><span class="line">    assertTrue(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="meta">@ValueSource</span>(strings = &#123;<span class="string">"0"</span>, <span class="string">"1.1"</span>, <span class="string">"2.2"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Demo4</span><span class="params">(BigDecimal arg)</span> </span>&#123;</span><br><span class="line">    assertEquals(BigDecimal.ZERO, arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-parameterized-tests-argument-conversion-implicit" target="_blank" rel="noopener">String可以自动转换成哪些格式？</a></p>
<h1 id="CsvSource"><a href="#CsvSource" class="headerlink" title="@CsvSource"></a><code>@CsvSource</code></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="meta">@CsvSource</span>(&#123;</span><br><span class="line">    <span class="string">"  85,  体育,         true"</span>,</span><br><span class="line">    <span class="string">"99.5,  '语,数,外',   false"</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Demo5</span><span class="params">(BigDecimal score, String subject, <span class="keyword">boolean</span> isWin)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ArgumentsAccessor-参数聚合器"><a href="#ArgumentsAccessor-参数聚合器" class="headerlink" title="ArgumentsAccessor 参数聚合器"></a>ArgumentsAccessor 参数聚合器</h2><p>通过<code>ArgumentsAccessor</code>一次接收多个参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="meta">@CsvSource</span>(&#123;</span><br><span class="line">    <span class="string">"  85,  体育,         true"</span>,</span><br><span class="line">    <span class="string">"99.5,  '语,数,外',   false"</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test_Demo6</span><span class="params">(ArgumentsAccessor args)</span> </span>&#123;</span><br><span class="line">    args.get(<span class="number">0</span> , BigDecimal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    args.get(<span class="number">1</span>, String<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">// OR args.getString(1);</span></span><br><span class="line">    args.get(<span class="number">2</span>, Boolean<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://junit.org/junit5/docs/current/api/org.junit.jupiter.params/org/junit/jupiter/params/aggregator/ArgumentsAccessor.html" target="_blank" rel="noopener">ArgumentsAccessor doc api</a></p>
<h1 id="CsvFileSource"><a href="#CsvFileSource" class="headerlink" title="@CsvFileSource"></a><code>@CsvFileSource</code></h1><p>和<code>@CsvSource</code>的区别，从csv文件读取测试数据，传参等用法相同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="meta">@CsvFileSource</span>(resources = <span class="string">"/login-data.csv"</span>, numLinesToSkip = <span class="number">1</span>)</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_Demo7</span><span class="params">(ArgumentsAccessor args)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2020/08/05/View-pod-log-in-K8S/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/05/View-pod-log-in-K8S/" class="post-title-link" itemprop="url">k8s | 查看k8s中应用的运行log</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-06 00:00:00" itemprop="dateCreated datePublished" datetime="2020-08-06T00:00:00+08:00">2020-08-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<p>自从应用的部署从tomcat转移到kubernetes之后，再也不能像下面这样一句命令查看日志了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f &#x2F;usr&#x2F;local&#x2F;tomcat6&#x2F;logs&#x2F;catalina.out</span><br></pre></td></tr></table></figure>

<p>在我记住k8s操作步骤之前，暂时记录下来以备忘。</p>
<h2 id="1-找到pod"><a href="#1-找到pod" class="headerlink" title="1. 找到pod"></a>1. 找到pod</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n&#x3D;test -o wide</span><br><span class="line">&#x2F;&#x2F; or</span><br><span class="line">kubectl get pods --namespace&#x3D;test -o wide</span><br><span class="line"></span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP        NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">mysql-df95554c9-hszrl      1&#x2F;1     Running   0          39d   a.b.c.d   k8s-node4   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">my-app-7c8fb75b76-spm8n    2&#x2F;2     Running   0          45m   a.b.c.d   k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-n=test</code>: 指定命名空间</li>
<li><code>-o wide</code>: 显示更多内容</li>
</ul>
<h2 id="2-找到container"><a href="#2-找到container" class="headerlink" title="2. 找到container"></a>2. 找到container</h2><p>当pod上有多个container时，需要明确查看哪个。</p>
<p>查找container的方式有两个，</p>
<ol>
<li>在应用部署的对应yaml文件中找到containers-&gt;name</li>
<li>在pod详情中找Container:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod my-app-7c8fb75b76-spm8n -n&#x3D;test</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>如果缺省这步的话，查看日志可能会遇到下面的提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl logs -f my-app-7c8fb75b76-spm8n -n test --tail&#x3D;500 --v&#x3D;1</span><br><span class="line">Error from server (BadRequest): a container name must be specified for pod my-app-7c8fb75b76-spm8n, choose one of: [my-app filebeat]</span><br></pre></td></tr></table></figure>

<h2 id="3-查看日志"><a href="#3-查看日志" class="headerlink" title="3. 查看日志"></a>3. 查看日志</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -f my-app-7c8fb75b76-spm8n -c partner-kpi -n test --tail&#x3D;500 --v&#x3D;1</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-c partner-kpi</code>: container容器</li>
<li><code>--tail=500</code>: 显示最新500行。可以换成<code>--since=1h</code>，这个也很实用</li>
<li><code>--v=1</code>: 日志级别1</li>
</ul>
<p>另外，k8s的命令中=号可以省略。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2020/07/29/Shell-script-NO001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/29/Shell-script-NO001/" class="post-title-link" itemprop="url">Shell | 删除最老的一份备份</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-30 00:00:00" itemprop="dateCreated datePublished" datetime="2020-07-30T00:00:00+08:00">2020-07-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h2 id="备份文件夹多于5个的话，删除最老的那个文件夹"><a href="#备份文件夹多于5个的话，删除最老的那个文件夹" class="headerlink" title="备份文件夹多于5个的话，删除最老的那个文件夹"></a>备份文件夹多于5个的话，删除最老的那个文件夹</h2><p>假设：<code>/home/backup/</code>下会定时生成备份目录，为省空间，最多允许保存<code>5</code>份备份，如果超过则删除最老的一份。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">SAVED_NUM=5</span><br><span class="line">num=`ls -l /home/backup/ | grep <span class="string">'^d'</span> | wc -l`;</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$num</span> -ge <span class="variable">$SAVED_NUM</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    rmfolder=`ls -tr /home/backup/ | head -n1`</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"To be deleted: <span class="variable">$&#123;rmfolder&#125;</span>"</span></span><br><span class="line">    rm -rf <span class="string">"/home/backup/<span class="variable">$&#123;rmfolder&#125;</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>讲解</strong><br>grep ‘^d’: 筛选出文件夹（因为文件夹属性信息是d开头）<br>wc -l    : 统计行数，即，统计有多少个文件夹<br>-ge      : 大于等于<br>ls -tr   : 按从旧到新排序，旧的排在前面<br>head -n1 : 选取排列的第一个文件，1可以按需改成其他数值</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2020/07/04/Xiaomi-install-custom-ROM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/04/Xiaomi-install-custom-ROM/" class="post-title-link" itemprop="url">小米6刷机</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-05 00:00:00" itemprop="dateCreated datePublished" datetime="2020-07-05T00:00:00+08:00">2020-07-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="刷官方ROM"><a href="#刷官方ROM" class="headerlink" title="刷官方ROM"></a>刷官方ROM</h1><h2 id="下载官方ROM"><a href="#下载官方ROM" class="headerlink" title="下载官方ROM"></a>下载官方ROM</h2><ul>
<li>下载所需官方版ROM</li>
<li>复制到手机存储，路径任意，根目录即可</li>
</ul>
<h2 id="开启隐藏功能【手动选择安装包】"><a href="#开启隐藏功能【手动选择安装包】" class="headerlink" title="开启隐藏功能【手动选择安装包】"></a>开启隐藏功能【手动选择安装包】</h2><ul>
<li>MIUI版本 界面，连续点击中间“11”图标</li>
<li>点击右上角【…】，手动选择安装包、重启到Recovery出现</li>
</ul>
<h1 id="刷第三方ROM"><a href="#刷第三方ROM" class="headerlink" title="刷第三方ROM"></a>刷第三方ROM</h1><p>第三方ROM，例如，<a href="https://forum.xda-developers.com/mi-6/development/rom-evolution-x-4-20-2-sagit-t4089445" target="_blank" rel="noopener">xda</a> 或 <a href="https://xiaomi.eu/community/threads/miui-11-0-stable-release.52628/" target="_blank" rel="noopener">eu</a></p>
<h2 id="1-开启USB调试"><a href="#1-开启USB调试" class="headerlink" title="1. 开启USB调试"></a>1. 开启<code>USB调试</code></h2><p>开启<code>开发者模式</code>：我的设备 → 全部参数 → MIUI版本 连续点击7次</p>
<p>开启<code>USB调试</code>：更多设置 → 开发人员选项 → USB调试模式。</p>
<p>手机USB插到电脑上。</p>
<h2 id="2-解锁BL（Bootloader）"><a href="#2-解锁BL（Bootloader）" class="headerlink" title="2. 解锁BL（Bootloader）"></a>2. 解锁BL（Bootloader）</h2><p><a href="http://www.miui.com/unlock/download.html" target="_blank" rel="noopener">http://www.miui.com/unlock/download.html</a></p>
<h2 id="3-安装TWRP"><a href="#3-安装TWRP" class="headerlink" title="3. 安装TWRP"></a>3. 安装TWRP</h2><blockquote>
<p>What is TWRP? TWRP is a Custom Recovery.</p>
<p>存在多种操作方式，其中，手机上安装app的方式需要root手机，所以，改用命令行<code>adb+fastboot</code>的方式</p>
</blockquote>
<ul>
<li>进入Fastboot</li>
</ul>
<p><code>adb reboot bootloader</code><br>如果未按预期进入Fastboot，则，先手动关机，再长按 <code>音量下</code>+<code>电源</code> 开机</p>
<ul>
<li>下载合适的 <code>twrp.img</code></li>
</ul>
<p><a href="https://twrp.me/xiaomi/xiaomimi6.html" target="_blank" rel="noopener">https://twrp.me/xiaomi/xiaomimi6.html</a></p>
<ul>
<li><p>刷twrp.img</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot flash recovery twrp.img</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入 Recovery TWRP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastboot boot twrp.img</span><br><span class="line">&#x2F;&#x2F; OR</span><br><span class="line">fastboot reboot</span><br></pre></td></tr></table></figure>
<p>如果未按预期进入TWRP，则，在Fastboot模式下，长按<code>音量上</code>+<code>电源</code>，等看到小米log时，只松开<code>电源</code>键，直到出现TWRP，再松开<code>音量上</code>。</p>
</li>
</ul>
<p>清数据，FORMAT /data partition (NEVER wipe System or Persist!)</p>
<ul>
<li>刷ROOM镜像</li>
</ul>
<p>把ROOM镜像放到手机存储</p>
<ul>
<li>完成</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="新系统引导界面，卡在Google账号验证"><a href="#新系统引导界面，卡在Google账号验证" class="headerlink" title="新系统引导界面，卡在Google账号验证"></a>新系统引导界面，卡在Google账号验证</h2><p>Tip: 刷机前，应在老系统中退出Google账号登陆，否则就会遇到这个问题。<br>如果你的网络可以穿墙，在手机尚无法安装设置其他app的情况下，其实这也不算个事儿。</p>
<p>解决办法：关闭新系统新机引导界面</p>
<ol>
<li>进入 Recovery TWRP</li>
<li>在菜单中完成/system分区。以防万一，adb中再次挂载<code>adb remount /system</code></li>
<li>进入shell，关闭引导<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">echo &quot;ro.setupwizard.mode&#x3D;DISABLED&quot; &gt;&gt; &#x2F;system&#x2F;build.prop</span><br></pre></td></tr></table></figure></li>
<li>系统重启</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2020/06/30/UT-Springboot-test-the-web-layer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/30/UT-Springboot-test-the-web-layer/" class="post-title-link" itemprop="url">UT | Controller层单元测试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-01 00:00:00" itemprop="dateCreated datePublished" datetime="2020-07-01T00:00:00+08:00">2020-07-01</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<p>我的环境：</p>
<ul>
<li>Java 8+</li>
<li>Maven 3</li>
<li>Spring Boot 2</li>
<li>Junit 5</li>
</ul>
<p>Controller的单元测试很多时候都不容易做到隔离，不得不依赖下层类的逻辑、数据库、网络、第三方服务等等，所以，有时人们又将它归为接口测试，类似于HTTP API测试。</p>
<h1 id="测试的几种类型"><a href="#测试的几种类型" class="headerlink" title="测试的几种类型"></a>测试的几种类型</h1><p>注意下面示例代码在类注释处的区别！</p>
<h2 id="1-启动服务，监听端口，发送真实的http请求"><a href="#1-启动服务，监听端口，发送真实的http请求" class="headerlink" title="1. 启动服务，监听端口，发送真实的http请求"></a>1. 启动服务，监听端口，发送真实的http请求</h2><p>Start the application up and listen for a connection like it would do in production, and then send an HTTP request and assert the response.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.test.web.client.TestRestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@RunWith</span>(SpringRunner.class) // needed if junit 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ExtendWith</span>(SpringExtension.class) // for junit 5</span></span><br><span class="line"><span class="comment"> * 正常情况下可省略，因<span class="doctag">@SpringBootTest</span>已包含，但是，如果你用的spring boot版本低，还是加上这个注解吧</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span>(webEnvironment = WebEnvironment.RANDOM_PORT)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpRequestTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@LocalServerPort</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> port; <span class="comment">// bind the above RANDOM_PORT</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGreeting</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    assertThat(restTemplate.getForObject(<span class="string">"http://localhost:"</span> + port + <span class="string">"/"</span>, String<span class="class">.<span class="keyword">class</span>))</span></span><br><span class="line">      .contains("Hello World");</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-不启动服务（但实例化整个上下文），却类似发送真实http请求"><a href="#2-不启动服务（但实例化整个上下文），却类似发送真实http请求" class="headerlink" title="2. 不启动服务（但实例化整个上下文），却类似发送真实http请求"></a>2. 不启动服务（但实例化整个上下文），却类似发送真实http请求</h2><p>The full Spring application context is started but without the server.</p>
<p>Another useful approach is to not start the server at all, but test only the layer below that, where Spring handles the incoming HTTP request and hands it off to your controller. That way, almost the full stack is used, and your code will be called exactly the same way as if it was processing a real HTTP request, but without the cost of starting the server.</p>
<blockquote>
<p>译：另一种有用的方法是根本不启动服务器，而是只测试下面的层，Spring在这一层处理传入的HTTP请求并将其传递给控制器。这样，几乎使用了整个堆栈，代码调用的方式与处理实际HTTP请求的方式完全相同，但是不需要启动服务器。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MockMvcExampleTests</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">testHelloWorld</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    mvc.perform(get(<span class="string">"/"</span>))</span><br><span class="line">      .andExpect(status().isOk())</span><br><span class="line">      .andExpect(content().string(<span class="string">"Hello World"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上两种方法会实例化整个上下文。（Spring Boot is instantiating the whole context.）</p>
<p>可以将<code>@SpringBootTest</code>理解成集成测试。</p>
<hr>
<p><em>注意上下两段代码，在类注释处的区别</em>  </p>
<p>方法3只实例化web层。<br>Spring Boot is only instantiating the web layer.（If you want to focus <strong><span style="color:red"><em>only</em></span> on the web layer</strong> and <strong><span style="color:red"><em>not start</em></span> a complete ApplicationContext</strong>, consider using <code>@WebMvcTest</code> instead.）</p>
<h2 id="3-不启动服务（仅实例化web层），却类似发送真实http请求"><a href="#3-不启动服务（仅实例化web层），却类似发送真实http请求" class="headerlink" title="3. 不启动服务（仅实例化web层），却类似发送真实http请求"></a>3. 不启动服务（仅实例化web层），却类似发送真实http请求</h2><p>In this test, the full Spring application context is started, but without the server. We can narrow down the tests to just the web layer by using <code>@WebMvcTest</code>.  </p>
<blockquote>
<p>译：在这个测试中，启动了完整的Spring应用程序上下文，但是没有服务器。我们可以使用<code>@WebMvcTest</code>将测试范围缩小到web层。<br>如果应用含有多个controller，可以使用<code>@WebMvcTest(homecontroler.class)</code>来只实例化一个控制器。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebMvcTest</span>(GreetingController<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">WebMockTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@MockBean</span></span><br><span class="line">  <span class="keyword">private</span> GreetingService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGreetingShouldReturnMessageFromService</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    when(service.greet()).thenReturn(<span class="string">"Hello Mock"</span>);</span><br><span class="line"></span><br><span class="line">    mockMvc.perform(get(<span class="string">"/greeting"</span>))</span><br><span class="line">      .accept(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">      <span class="comment">// 添加ResultHandler结果处理器，比如调试时打印结果到控制台，更多处理器可查阅</span></span><br><span class="line">      .andDo(print())</span><br><span class="line">      <span class="comment">// 添加ResultMatcher验证规则，验证请求结果是否正确</span></span><br><span class="line">      .andExpect(status().isOk())</span><br><span class="line">      <span class="comment">// andReturn：返回执行请求的结果，该结果是一个MvcResult实例对象</span></span><br><span class="line">      .andExpect(content().string(containsString(<span class="string">"Hello Mock"</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-Mock下层所有调用"><a href="#4-Mock下层所有调用" class="headerlink" title="4. Mock下层所有调用"></a>4. Mock下层所有调用</h2><p>只关注<code>Controller</code>层逻辑，被测中所涉及的调用全部打桩、mock掉。</p>
<p>与其他三个相比，方法4是比较合乎分层测试理念的方式。但在实际项目中，个人的体会，这种方式可操作性并不强。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockitoControllerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@InjectMocks</span></span><br><span class="line">  <span class="keyword">private</span> UserController userController;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Mock</span></span><br><span class="line">  <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@BeforeEach</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MockitoAnnotations.initMocks(<span class="keyword">this</span>); <span class="comment">//【必须！】初始化@Mock</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetUserById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User u = <span class="keyword">new</span> User();</span><br><span class="line">    u.setId(<span class="number">1L</span>);</span><br><span class="line">    </span><br><span class="line">    when(userRepository.findOne(<span class="number">1L</span>)).thenReturn(u);</span><br><span class="line"></span><br><span class="line">    User user = userController.get(<span class="number">1L</span>);</span><br><span class="line">    verify(userRepository).findOne(<span class="number">1L</span>);</span><br><span class="line">    assertEquals(<span class="number">1l</span>, user.getId().longValue());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="重要注解"><a href="#重要注解" class="headerlink" title="重要注解"></a>重要注解</h1><h2 id="SpringBootTest"><a href="#SpringBootTest" class="headerlink" title="@SpringBootTest"></a><code>@SpringBootTest</code></h2><p>The <code>@SpringBootTest</code> annotation tells Spring Boot to go and look for a main configuration class (one with <code>@SpringBootApplication</code> for instance), and use that to <strong>start a Spring application context</strong>.</p>
<p>注释告诉SpringBoot去寻找一个主配置类（例如带有<code>@SpringBootApplication</code>的配置类），并使用它来启动一个Spring应用程序上下文。</p>
<blockquote>
<p>Springboot默认只启动一次应用，并缓存它。对于使用配置相同的多个tc，或者一个tc中的多个method，就可以共用它。当然，可以使用<code>@DirtiesContext</code>来控制缓存。</p>
</blockquote>
<p>它有两个属性：</p>
<ul>
<li>webEnvironment：指定Web应用环境，它可以是以下值<ul>
<li>MOCK：提供一个模拟的 Servlet 环境，内置的 Servlet 容器没有启动（不会对Servlet、Filter、Listener等进行初始化），配合可以与@AutoConfigureMockMvc 结合使用，用于基于 MockMvc 的应用程序测试。</li>
<li>RANDOM_PORT：加载一个 EmbeddedWebApplicationContext 并提供一个真正嵌入式的 Servlet 环境，随机端口。</li>
<li>DEFINED_PORT：加载一个 EmbeddedWebApplicationContext 并提供一个真正嵌入式的 Servlet 环境，默认端口 8080 或由配置文件指定。</li>
<li>NONE：使用 SpringApplication 加载 ApplicationContext，但不提供任何 servlet 环境。</li>
</ul>
</li>
<li>classes：指定应用启动类，通常情况下无需设置，因为 SpringBoot 会自动搜索，直到找到 @SpringBootApplication 或 @SpringBootConfiguration 注解。</li>
</ul>
<h2 id="Transactional"><a href="#Transactional" class="headerlink" title="@Transactional"></a><code>@Transactional</code></h2><p>它会在每个测试方法结束时会进行回滚操作。<br>但是，如果使用 <code>RANDOM_PORT</code> 或 <code>DEFINED_PORT</code> 这样的Servlet环境，HTTP客户端和服务器将在不同的线程中运行，从而分离事务。所以，在这种情况下，在服务器上启动的任何事务都不会回滚。</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p><a href="https://spring.io/guides/gs/testing-web/" target="_blank" rel="noopener">Offical &gt; Testing the Web Layer</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://peterquan.github.io/2020/06/29/CSS-Selector-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.webp">
      <meta itemprop="name" content="权芹乐">
      <meta itemprop="description" content="时间需要留下走过的痕迹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Quan Qinle">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/29/CSS-Selector-summary/" class="post-title-link" itemprop="url">Selenium | 元素定位By.cssSelector()</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-30 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-30T00:00:00+08:00">2020-06-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<p>CSS Selector 使用CSS定位元素</p>
<h1 id="CSS-Selector是什么？"><a href="#CSS-Selector是什么？" class="headerlink" title="CSS Selector是什么？"></a><code>CSS Selector</code>是什么？</h1><blockquote>
<p>[MDN web docs]</p>
<p>CSS selectors define the elements to which a set of CSS rules apply.</p>
</blockquote>
<blockquote>
<p>[w3schools]</p>
<p>In CSS, selectors are patterns used to select the element(s) you want to style.</p>
</blockquote>
<h1 id="CSS-Selector语法"><a href="#CSS-Selector语法" class="headerlink" title="CSS Selector语法"></a>CSS Selector语法</h1><h2 id="4个基础选择器"><a href="#4个基础选择器" class="headerlink" title="4个基础选择器"></a>4个基础选择器</h2><p>个人认为，<code>CSS Selector</code>最重要的选择器只有下面4个，分别是 tagname标签名称，标签id属性，class属性，以及其他属性：</p>
<ul>
<li>tag</li>
<li>#id</li>
<li>.class</li>
<li>[attribute=value]</li>
</ul>
<p>这4个的各种组合，可以出现丰富、强大的效果。</p>
<p>举几个例子</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tag</span><span class="selector-id">#id</span></span><br><span class="line"><span class="selector-tag">tag</span><span class="selector-class">.class</span></span><br><span class="line">tag.class1.class2   // 多个class</span><br><span class="line"><span class="selector-tag">tag</span><span class="selector-attr">[attributeName=<span class="string">'attributeValue'</span>]</span></span><br><span class="line">tag[attributeName='attributeValue'][attributeName2='attributeValue2'] // 多个属性</span><br><span class="line">tag#id.class[attributeName='attributeValue'] // 4个选择器</span><br></pre></td></tr></table></figure>

<h2 id="更多选择器"><a href="#更多选择器" class="headerlink" title="更多选择器"></a>更多选择器</h2><p>下面再列几个我常用的选择器。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*-- 属性的模糊匹配 --*/</span></span><br><span class="line">// ^ - Starts with</span><br><span class="line"><span class="selector-attr">[attribute^=<span class="string">'attributeValue'</span>]</span></span><br><span class="line">// $ - Ends with</span><br><span class="line"><span class="selector-attr">[attribute$=<span class="string">'attributeValue'</span>]</span></span><br><span class="line">// * - Contains</span><br><span class="line"><span class="selector-attr">[attribute*=<span class="string">'attributeValue'</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-- 父子节点 --*/</span></span><br><span class="line">// 直接子节点，多个（parentLocator&gt;childLocator）。XPath: //div/a</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-id">#buttonDiv</span>&gt;<span class="selector-tag">button</span></span><br><span class="line">// 相对子节点，多个（locator1 locator2）。XPath: //div//a</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-id">#buttonDiv</span> <span class="selector-tag">button</span></span><br><span class="line">// 同一父节点下的第n个子元素，从1开始（:nth-child(n)）。下例，若li不是其父的第2位节点，则失败；数位子时，所有类型一起数</span><br><span class="line"><span class="selector-id">#testingTypes</span> <span class="selector-tag">li</span><span class="selector-pseudo">:nth-child(2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-- 兄弟节点 --*/</span></span><br><span class="line">// 紧邻的下一个节点，1个（locator1+locator2）</span><br><span class="line"><span class="selector-tag">li</span><span class="selector-id">#automation</span> + <span class="selector-tag">li</span></span><br><span class="line">// 其后的兄弟节点，可以被其他兄弟隔断（element1~element2）</span><br><span class="line"><span class="selector-tag">p</span>~<span class="selector-tag">ul</span></span><br></pre></td></tr></table></figure>

<p>CSS Selector还有其他复杂的语法，但上面我们讲到的已经是精华，实用性最强。</p>
<p>更多的见资料 [^1]</p>
<h1 id="Selenium中的CSS-Selector"><a href="#Selenium中的CSS-Selector" class="headerlink" title="Selenium中的CSS Selector"></a><code>Selenium</code>中的<code>CSS Selector</code></h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">By by &#x3D; By.cssSelector(String selector);</span><br><span class="line">&#x2F;&#x2F;Find elements via the driver&#39;s underlying W3C Selector engine.</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">By.cssSelector(<span class="string">"button[id='stop']"</span>)  </span><br><span class="line">By.cssSelector(<span class="string">"button#stop"</span>)  </span><br><span class="line">By.cssSelector(<span class="string">"#stop"</span>)  </span><br><span class="line"></span><br><span class="line">By.cssSelector(<span class="string">"button.x-right-button"</span>)   </span><br><span class="line">By.cssSelector(<span class="string">".x-right-button"</span>) </span><br><span class="line"><span class="comment">// &lt;button class="x-btn-text module_picker_icon" /&gt; </span></span><br><span class="line">By.cssSelector(<span class="string">"button.x-btn-text.module_picker_icon"</span>)  <span class="comment">// 多个class</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//^=start with $=ends with *=contains</span></span><br><span class="line">By.cssSelector(<span class="string">"input[id^='Em']"</span>)</span><br><span class="line">By.cssSelector(<span class="string">"input[id$='wd']"</span>)</span><br><span class="line">By.cssSelector(<span class="string">"input[id*='ni']"</span>) <span class="comment">// 使用a[href*='.jpg']成功！</span></span><br><span class="line">By.cssSelector(<span class="string">"a:contains('Sign in')"</span>) </span><br><span class="line"><span class="comment">//contains试用失败！原因见下文invalid selector: An invalid or illegal selector was specified</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">By.cssSelector(<span class="string">"a[title=\"Go to Facebook home\"]"</span>)</span><br><span class="line">By.cssSelector(<span class="string">"input[id='signIn'][value='Sign in']"</span>) <span class="comment">// 多个属性</span></span><br><span class="line">By.cssSelector(<span class="string">"div#west-panel&gt;div:nth-child(1)&gt;div:nth-child(1)&gt;div:nth-child(2)&gt;div"</span>) </span><br><span class="line">By.cssSelector(<span class="string">"td.col5&gt;div&gt;input:nth-child(4)"</span>) <span class="comment">// nth-child(4) 表示查找第四个Pseudo-selements元素</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// XPATH: //input[@id='username']/following-sibling::input[1]</span></span><br><span class="line">By.cssSelector(<span class="string">".username + input"</span>)</span><br></pre></td></tr></table></figure>


<h1 id="不能通过文本contains定位元素的问题"><a href="#不能通过文本contains定位元素的问题" class="headerlink" title="不能通过文本contains定位元素的问题"></a>不能通过文本<code>contains</code>定位元素的问题</h1><p>有一点需要特别注意，不能使用 <code>a:contains(&#39;Sign in&#39;)</code>。</p>
<p>原因：</p>
<ol>
<li><strong>Inner texts</strong><br>are the actual string patterns that the HTML label shows on the page.  </li>
<li>(Not supported by WebDriver)<br>CSS: The CSS2 contains() function is not in CSS3; however, Selenium supports the superset of CSS1, 2, and 3.<br>contains() is not part of the current CSS3 specification so it will not work on all browsers, only ones that implemented it before it was pulled.</li>
</ol>
<p>遇到此种场景，可以使用<code>By by = By.ByXPath(String xpathExpression)</code>。<br>xpath见资料 [^2]</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p>[^1]: CSS Selector详解：<a href="https://www.w3schools.com/cssref/css_selectors.asp" target="_blank" rel="noopener">https://www.w3schools.com/cssref/css_selectors.asp</a></p>
<p>[^2]: CSS Selector与xpath语法比较：<a href="https://saucelabs.com/resources/articles/selenium-tips-css-selectors" target="_blank" rel="noopener">https://saucelabs.com/resources/articles/selenium-tips-css-selectors</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="权芹乐"
      src="/images/avatar.webp">
  <p class="site-author-name" itemprop="name">权芹乐</p>
  <div class="site-description" itemprop="description">时间需要留下走过的痕迹</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">权芹乐</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
